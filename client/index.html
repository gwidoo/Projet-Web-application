<!DOCTYPE html>
<html>
 <head>
  <script src="leaflet.js"> // Bibliothèque Leaflet : http://leafletjs.com/ </script>

  <title>index</title>
  <meta charset="utf-8">
  
  <link rel="stylesheet" type="text/css" href="leaflet.css" /> 
  <link rel="stylesheet" type="text/css" href="style.css"/>

  <style>
body {
 background-image: linear-gradient(0deg, darkolivegreen, darkslategrey, darkslategrey);
 padding-left: 20px;
 padding-right: 20px;
}
h1 {
 margin-left: -20px;
 margin-right: -20px;
 padding-left: 20px;
}
#map {
  float: left;
  margin-right: 20px;
}
#courbe {
	width: calc(100vw - 480px);
}
#courbe, #map {
	border: 1px solid black;
	border-radius: 7px;
	box-shadow: 7px 7px 7px rgba(0,0,0,0.5);
}
#reponse {
  visibility: hidden;
}
#reponse p {
  font-size: 1.5em;
  color: orange;
}
  </style>
 </head>
 <body onload="load_data();">
  <h1>Pollution atmosphérique</h1>
  
  <!-- Zone pour l'insertion de la carte OSM via Leaflet -->
  <div id="map" style="margin-bottom:1.33em"></div>  

  <div id="reponse">
     <p></p>
     <img id="courbe">
  </div>
  
<script>
// Création d'une carte dans la balise div "map",
// et position de la vue sur un point donné et un niveau de zoom
var map = L.map('map').setView([47,2.5], 5);

// Ajout d'une couche de dalles OpenStreetMap
L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
     attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
     }).addTo(map);

// Fonction appelée au chargement de la page
function load_data() {

  // objet pour l'envoi d'une requête Ajax
  var xhr = new XMLHttpRequest();

  // fonction appelée lorsque la réponse à la requête (liste des lieux insolites) sera arrivée
  xhr.onload = function() {

    // transformation des données renvoyées par le serveur
    // responseText est du type string, data est une liste
    var data = JSON.parse(this.responseText);

    // boucle sur les lieux
    for ( n = 0; n < data.length; n++ ) {
      // insertion d'un marqueur à la position du lieu,
      // attachement d'une popup, capture de l'événement 'clic'
      // ajout d'une propriété personnalisée au marqueur
      L.marker([data[n].lat,data[n].lon]).addTo(map)
       .bindPopup('Région = '+data[n].nom)
       .addEventListener('click',OnMarkerClick)
       .idnum = data[n].nom;
    }
  };

  // Envoi de la requête Ajax pour la récupération de la liste des lieux insolites
  xhr.open('GET','/regions',true);
  xhr.send();
}

// Fonction appelée lors d'un clic sur un marqueur
function OnMarkerClick (e) {
  // éléments pour insérer la réponse
  var reponse = document.getElementById('reponse'),
      image =  document.querySelector('#reponse img'),  
      legende = document.querySelector('#reponse p');
  
  // objet pour l'envoi d'une requête Ajax
  var xhr = new XMLHttpRequest();

  // fonction appelée lorsque la réponse à la requête (description d'un lieu insolite) sera arrivée
  xhr.onload = function() {
    // récupération des informations de la réponse
	var data = JSON.parse(this.responseText);
	
    // affichage dans la zone 'reponse' des informations récupérées par l'appel au serveur
    image.src = data.img;
	legende.innerHTML = data.title;

	reponse.style.visibility = 'visible';

  };

  // Le numéro du lieu est récupéré via la propriété personnalisée du marqueur
  var idnum = e.target.idnum

  // Envoi de la requête Ajax pour la récupération de la description du lieu de numéro idnum
  xhr.open('GET','/ponctualite/'+idnum,true);
  xhr.send();
}    
</script>
 </body>
</html> 